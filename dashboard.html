<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-4">Management Dashboard</h1>

        <div class="p-4 bg-white rounded-lg shadow-md mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="search" class="block text-sm font-medium text-gray-700">Search by Initials, SO#, or Part#</label>
                    <input type="text" id="search" placeholder="Enter search term..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="dateFilter" class="block text-sm font-medium text-gray-700">Filter by Date</label>
                    <input type="date" id="dateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                </div>
                <div>
                    <button id="resetFilters" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Reset Filters</button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Initials</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shop Order #</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Part #</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Good Qty</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Scrap Qty</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Downtime (min)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                    <tr><td colspan="8" class="text-center p-8 text-gray-500">Loading data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="detailsModal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-95">
            <div class="p-6">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Report Details</h2>
                    <button id="closeModal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div id="modalContent" class="space-y-6">
                    </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAs6ffwTDsQxptnpFdxIPdeRUND7cvm94c",
            authDomain: "sfeod-2025.firebaseapp.com",
            projectId: "sfeod-2025",
            storageBucket: "sfeod-2025.firebasestorage.app",
            messagingSenderId: "189312482883",
            appId: "1:189312482883:web:8161ee4fe5bbfb35389ef6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const reportTableBody = document.getElementById('reportTableBody');
        const searchInput = document.getElementById('search');
        const dateFilterInput = document.getElementById('dateFilter');
        const resetBtn = document.getElementById('resetFilters');
        const modal = document.getElementById('detailsModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalContent = document.getElementById('modalContent');
        
        let allReports = [];

        async function fetchReports() {
            reportTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-gray-500">Loading data...</td></tr>';
            try {
                const reportsRef = collection(db, 'reports');
                const selectedDate = dateFilterInput.value;

                let q;
                if (selectedDate) {
                    q = query(reportsRef, where("date", "==", selectedDate), orderBy("createdAt", "desc"));
                } else {
                    q = query(reportsRef, orderBy("createdAt", "desc"));
                }
                
                const querySnapshot = await getDocs(q);
                allReports = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderTable(allReports);
                if (allReports.length === 0) {
                   reportTableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-gray-500">No reports found for the selected criteria.</td></tr>';
                }
            } catch (error) {
                console.error("Error fetching reports: ", error);
                reportTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-red-500">Error loading data: ${error.message}</td></tr>`;
            }
        }

        function renderTable(reports) {
            reportTableBody.innerHTML = '';
            reports.forEach(report => {
                const totalDowntime = report.downtime.reduce((acc, item) => acc + item.duration, 0);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${report.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${report.initials}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${report.shopOrder}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${report.partNumber}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-green-600 font-semibold">${report.qtyGood}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-red-600 font-semibold">${report.qtyScrapped}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${totalDowntime}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="view-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-1 px-3 rounded">View</button>
                    </td>
                `;
                tr.querySelector('.view-btn').addEventListener('click', () => showDetails(report));
                reportTableBody.appendChild(tr);
            });
        }
        
        function filterData() {
            const searchTerm = searchInput.value.toLowerCase();
            if (!searchTerm) {
                renderTable(allReports);
                return;
            }
            const filteredReports = allReports.filter(report => 
                report.initials.toLowerCase().includes(searchTerm) ||
                report.shopOrder.toLowerCase().includes(searchTerm) ||
                report.partNumber.toLowerCase().includes(searchTerm)
            );
            renderTable(filteredReports);
        }

        function showDetails(report) {
            const setup = report.setupSuggestion;
            const downtimeHtml = report.downtime.length > 0 ? report.downtime.map(d => `<li>${d.reason}: <strong>${d.duration} min</strong></li>`).join('') : '<li>None</li>';
            const toolingHtml = report.toolingRequests.length > 0 ? report.toolingRequests.map(t => `<li>${t.name} (Print: ${t.print}): <strong>Qty ${t.amount}</strong></li>`).join('') : '<li>None</li>';

            modalContent.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div><strong>Date:</strong><br>${report.date}</div>
                    <div><strong>Initials:</strong><br>${report.initials}</div>
                    <div><strong>Shop Order:</strong><br>${report.shopOrder}</div>
                    <div><strong>Part #:</strong><br>${report.partNumber}</div>
                    <div><strong>Run Time:</strong><br>${report.runTime} hrs</div>
                    <div><strong>Good Qty:</strong><br>${report.qtyGood}</div>
                    <div><strong>Scrap Qty:</strong><br>${report.qtyScrapped}</div>
                    <div><strong>Scrap Reason:</strong><br>${report.scrapReason}</div>
                </div>

                <div class="pt-4 border-t mt-4">
                    <h3 class="font-bold text-lg mb-2">Downtime Events</h3>
                    <ul class="list-disc list-inside">${downtimeHtml}</ul>
                </div>
                
                <div class="pt-4 border-t mt-4">
                    <h3 class="font-bold text-lg mb-2">Tooling Requests</h3>
                    <ul class="list-disc list-inside">${toolingHtml}</ul>
                </div>

                <div class="pt-4 border-t mt-4">
                    <h3 class="font-bold text-lg mb-2">Setup Suggestion Details</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm bg-gray-50 p-3 rounded-md">
                        <div><strong>Setup Time:</strong> ${setup.setupTime || 'N/A'} min</div>
                        <div><strong>Qualify Time:</strong> ${setup.qualifyTime || 'N/A'} min</div>
                        <div><strong>Slit Width In:</strong> ${setup.stripWidthIn || 'N/A'} mm</div>
                        <div><strong>Bihler Width In:</strong> ${setup.stripWidthBihler || 'N/A'} mm</div>
                        <div><strong>Slit Thick In:</strong> ${setup.stripThicknessIn || 'N/A'} mm</div>
                        <div><strong>Bihler Thick In:</strong> ${setup.stripThicknessBihler || 'N/A'} mm</div>
                        <div><strong>Window Shim:</strong> ${setup.windowRollShim || 'N/A'}</div>
                        <div><strong>Window Pressure:</strong> ${setup.windowRollPressure || 'N/A'}</div>
                        <div><strong>DBL:</strong> ${setup.dbl || 'N/A'}</div>
                        <div><strong>Mandrel Size:</strong> ${setup.mandrelSize || 'N/A'}</div>
                        <div><strong>Cal. Die Size:</strong> ${setup.calibrationDieSize || 'N/A'}</div>
                        <div class="col-span-full"><strong>Setup Notes:</strong><br><p class="whitespace-pre-wrap font-mono text-xs p-2 bg-gray-200 rounded mt-1">${setup.setupNotes || 'None'}</p></div>
                    </div>
                </div>

                <div class="pt-4 border-t mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><h3 class="font-bold text-lg mb-2">Maintenance Issues</h3><p class="text-sm p-2 bg-gray-50 rounded min-h-[50px]">${report.maintenanceIssues || 'None'}</p></div>
                    <div><h3 class="font-bold text-lg mb-2">Quality Issues</h3><p class="text-sm p-2 bg-gray-50 rounded min-h-[50px]">${report.qualityIssues || 'None'}</p></div>
                    <div><h3 class="font-bold text-lg mb-2">General Notes</h3><p class="text-sm p-2 bg-gray-50 rounded min-h-[50px]">${report.generalNotes || 'None'}</p></div>
                </div>
            `;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            setTimeout(() => modal.querySelector('.modal-content').classList.remove('scale-95'), 10);
        }

        function hideDetails() {
            modal.querySelector('.modal-content').classList.add('scale-95');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // Event Listeners
        searchInput.addEventListener('input', filterData);
        dateFilterInput.addEventListener('change', fetchReports);
        resetBtn.addEventListener('click', () => {
            searchInput.value = '';
            dateFilterInput.value = '';
            fetchReports();
        });
        closeModalBtn.addEventListener('click', hideDetails);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) hideDetails();
        });
        
        // Initial data load
        fetchReports();
    </script>
</body>
</html>
